import{r as m,u as L,j as e}from"./react-vendor-DaFTMQpG.js";import{u as P,s as h}from"./admin-core-DIkG70u3.js";import"./vendor-D3cU5zLX.js";import"./aws-sdk-abEXkGUS.js";import"./ui-components-ZiW824g0.js";import"./supabase-SVDmTrDh.js";const F=()=>{var R;const[u,E]=m.useState(null),[v,N]=m.useState(null),[D,S]=m.useState(!0),[w,k]=m.useState(null),[r,n]=m.useState({supabaseUrl:"",hasAnonKey:!1,authStatus:"checking",networkRequests:[],rlsError:null}),b=L(),{toast:y}=P();return m.useEffect(()=>{const l=()=>{const o="https://vetufvhzmawjbsumtplq.supabase.co";return console.log("üîß Supabase Configuration Check:"),console.log("URL:",`${o.substring(0,30)}...`),console.log("Anon Key:","SET"),n(i=>({...i,supabaseUrl:o,hasAnonKey:!0})),!0},f=async()=>{var o,i,g;try{if(S(!0),!l())return;console.log("üîê Checking authentication...");const{data:{session:x},error:j}=await h.auth.getSession();if(j)throw console.error("‚ùå Session error:",j),j;console.log("üìä Session status:",x?"Active":"No session");const{data:{user:c},error:p}=await h.auth.getUser();if(n(t=>({...t,authStatus:c?"authenticated":"not authenticated",networkRequests:[...t.networkRequests,{type:"auth.getUser",success:!p,timestamp:new Date().toISOString()}]})),p)throw console.error("‚ùå Error fetching user:",p),p;if(!c){console.log("üö™ No user found, redirecting to login"),b("/login");return}console.log("‚úÖ User authenticated:",c.id),E(c),console.log("üìù Fetching user profile...");const{data:U,error:a}=await h.from("profiles").select("*").eq("id",c.id).single();if(n(t=>({...t,networkRequests:[...t.networkRequests,{type:"profiles.select",success:!a,error:a==null?void 0:a.message,timestamp:new Date().toISOString()}]})),a)if(console.error("‚ùå Error fetching profile:",a),(o=a.message)!=null&&o.includes("policy")&&n(t=>({...t,rlsError:"Row Level Security (RLS) policy may be blocking access to profiles table"})),a.code==="PGRST116"){console.log("üìù Profile not found, creating new profile...");const{data:t,error:s}=await h.from("profiles").insert([{id:c.id,email:c.email,updated_at:new Date().toISOString()}]).select().single();if(n(d=>({...d,networkRequests:[...d.networkRequests,{type:"profiles.insert",success:!s,error:s==null?void 0:s.message,timestamp:new Date().toISOString()}]})),s)throw console.error("‚ùå Error creating profile:",s),(i=s.message)!=null&&i.includes("policy")&&n(d=>({...d,rlsError:"RLS policy is blocking profile creation. Check INSERT policy for profiles table."})),s;N(t),console.log("‚úÖ Profile created successfully")}else throw a;else N(U),console.log("‚úÖ Profile fetched successfully");console.log("üß™ Testing access to other tables...");const A=["chats","messages","wisdom"];for(const t of A)try{const{error:s}=await h.from(t).select("id").limit(1);n(d=>({...d,networkRequests:[...d.networkRequests,{type:`${t}.select`,success:!s,error:s==null?void 0:s.message,timestamp:new Date().toISOString()}]})),(g=s==null?void 0:s.message)!=null&&g.includes("policy")&&console.warn(`‚ö†Ô∏è RLS issue with ${t} table:`,s.message)}catch(s){console.error(`‚ùå Error testing ${t} table:`,s)}}catch(x){console.error("‚ùå Dashboard data fetch error:",x),k(x.message),y({title:"Error",description:"Failed to load dashboard data. Check console for details.",variant:"destructive"})}finally{S(!1)}},{data:{subscription:I}}=h.auth.onAuthStateChange(async(o,i)=>{var g;console.log("üîÑ Auth state changed:",o,(g=i==null?void 0:i.user)==null?void 0:g.id),o==="SIGNED_IN"||o==="TOKEN_REFRESHED"?await f():o==="SIGNED_OUT"&&b("/login")});return f(),()=>{I.unsubscribe()}},[b,y]),D?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"}),e.jsx("p",{className:"mt-4",children:"Loading dashboard..."})]})}):w?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center max-w-2xl mx-auto p-8",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Dashboard Error"}),e.jsxs("p",{className:"text-red-500 mb-4",children:["Error: ",w]}),e.jsxs("div",{className:"bg-gray-100 p-4 rounded text-left mb-4",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Debug Information:"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Supabase URL:"})," ",r.supabaseUrl]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Anon Key:"})," ",r.hasAnonKey?"Present":"Missing"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Auth Status:"})," ",r.authStatus]}),r.rlsError&&e.jsxs("p",{className:"text-red-600",children:[e.jsx("strong",{children:"RLS Error:"})," ",r.rlsError]})]})]}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Refresh Page"})]})}):e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Dashboard"}),e.jsxs("div",{className:"bg-gray-100 p-4 rounded mb-4",children:[e.jsx("h2",{className:"font-semibold mb-2",children:"Debug Info:"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:"User Info:"}),e.jsxs("p",{className:"text-sm",children:["User ID: ",u==null?void 0:u.id]}),e.jsxs("p",{className:"text-sm",children:["Email: ",u==null?void 0:u.email]}),e.jsxs("p",{className:"text-sm",children:["Auth Status: ",r.authStatus]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:"Supabase Config:"}),e.jsxs("p",{className:"text-sm",children:["URL: ",(R=r.supabaseUrl)==null?void 0:R.substring(0,30),"..."]}),e.jsxs("p",{className:"text-sm",children:["Anon Key: ",r.hasAnonKey?"‚úÖ Set":"‚ùå Missing"]})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"font-medium",children:"Profile Data:"}),e.jsx("pre",{className:"text-xs bg-white p-2 rounded overflow-auto",children:JSON.stringify(v,null,2)})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"font-medium",children:"Network Requests:"}),e.jsx("div",{className:"space-y-1 text-xs",children:r.networkRequests.map((l,f)=>e.jsxs("div",{className:`p-1 ${l.success?"bg-green-100":"bg-red-100"}`,children:[l.timestamp,": ",l.type," - ",l.success?"‚úÖ Success":`‚ùå Failed: ${l.error}`]},f))})]}),r.rlsError&&e.jsxs("div",{className:"mt-4 p-3 bg-red-100 border border-red-300 rounded",children:[e.jsx("p",{className:"text-red-700 font-medium",children:"‚ö†Ô∏è RLS Policy Issue Detected:"}),e.jsx("p",{className:"text-red-600 text-sm",children:r.rlsError})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"})]})};export{F as default};
