import{j as e}from"./ui-D8yO-OxE.js";import{r as m,u as L}from"./vendor-XhsmhKu1.js";import{u as C,s as h}from"./index-DRBMqcxT.js";function O(n){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(n)}const T=()=>{var E;const[n,R]=m.useState(null),[D,N]=m.useState(null),[v,S]=m.useState(!0),[w,k]=m.useState(null),[t,l]=m.useState({supabaseUrl:"",hasAnonKey:!1,authStatus:"checking",networkRequests:[],rlsError:null}),b=L(),{toast:y}=C();return m.useEffect(()=>{const c=()=>{const o="https://vetufvhzmawjbsumtplq.supabase.co";return console.log("üîß Supabase Configuration Check:"),console.log("URL:",`${o.substring(0,30)}...`),console.log("Anon Key:","SET"),l(i=>({...i,supabaseUrl:o,hasAnonKey:!0})),!0},x=async()=>{var o,i,g;try{if(S(!0),!c())return;console.log("üîê Checking authentication...");const{data:{session:f},error:j}=await h.auth.getSession();if(j)throw console.error("‚ùå Session error:",j),j;console.log("üìä Session status:",f?"Active":"No session");const{data:{user:d},error:p}=await h.auth.getUser();if(l(r=>({...r,authStatus:d?"authenticated":"not authenticated",networkRequests:[...r.networkRequests,{type:"auth.getUser",success:!p,timestamp:new Date().toISOString()}]})),p)throw console.error("‚ùå Error fetching user:",p),p;if(!d){console.log("üö™ No user found, redirecting to login"),b("/login");return}console.log("‚úÖ User authenticated:",d.id),R(d),console.log("üìù Fetching user profile...");const{data:U,error:a}=await h.from("profiles").select("*").eq("id",d.id).single();if(l(r=>({...r,networkRequests:[...r.networkRequests,{type:"profiles.select",success:!a,error:a==null?void 0:a.message,timestamp:new Date().toISOString()}]})),a)if(console.error("‚ùå Error fetching profile:",a),(o=a.message)!=null&&o.includes("policy")&&l(r=>({...r,rlsError:"Row Level Security (RLS) policy may be blocking access to profiles table"})),a.code==="PGRST116"){console.log("üìù Profile not found, creating new profile...");const{data:r,error:s}=await h.from("profiles").insert([{id:d.id,email:d.email,updated_at:new Date().toISOString()}]).select().single();if(l(u=>({...u,networkRequests:[...u.networkRequests,{type:"profiles.insert",success:!s,error:s==null?void 0:s.message,timestamp:new Date().toISOString()}]})),s)throw console.error("‚ùå Error creating profile:",s),(i=s.message)!=null&&i.includes("policy")&&l(u=>({...u,rlsError:"RLS policy is blocking profile creation. Check INSERT policy for profiles table."})),s;N(r),console.log("‚úÖ Profile created successfully")}else throw a;else N(U),console.log("‚úÖ Profile fetched successfully");console.log("üß™ Testing access to other tables...");const A=["chats","messages","wisdom"];for(const r of A)try{const{error:s}=await h.from(r).select("id").limit(1);l(u=>({...u,networkRequests:[...u.networkRequests,{type:`${r}.select`,success:!s,error:s==null?void 0:s.message,timestamp:new Date().toISOString()}]})),(g=s==null?void 0:s.message)!=null&&g.includes("policy")&&console.warn(`‚ö†Ô∏è RLS issue with ${r} table:`,s.message)}catch(s){console.error(`‚ùå Error testing ${r} table:`,s)}}catch(f){console.error("‚ùå Dashboard data fetch error:",f),k(f instanceof Error?f.message:"An error occurred"),y({title:"Error",description:"Failed to load dashboard data. Check console for details.",variant:"destructive"})}finally{S(!1)}},{data:{subscription:I}}=h.auth.onAuthStateChange(async(o,i)=>{var g;console.log("üîÑ Auth state changed:",o,(g=i==null?void 0:i.user)==null?void 0:g.id),o==="SIGNED_IN"||o==="TOKEN_REFRESHED"?await x():o==="SIGNED_OUT"&&b("/login")});return x(),()=>{I.unsubscribe()}},[b,y]),v?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"}),e.jsx("p",{className:"mt-4",children:"Loading dashboard..."})]})}):w?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center max-w-2xl mx-auto p-8",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Dashboard Error"}),e.jsxs("p",{className:"text-red-500 mb-4",children:["Error: ",w]}),e.jsxs("div",{className:"bg-gray-100 p-4 rounded text-left mb-4",children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Debug Information:"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Supabase URL:"})," ",t.supabaseUrl]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Anon Key:"})," ",t.hasAnonKey?"Present":"Missing"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Auth Status:"})," ",t.authStatus]}),t.rlsError&&e.jsxs("p",{className:"text-red-600",children:[e.jsx("strong",{children:"RLS Error:"})," ",t.rlsError]})]})]}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Refresh Page"})]})}):e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Dashboard"}),e.jsxs("div",{className:"bg-gray-100 p-4 rounded mb-4",children:[e.jsx("h2",{className:"font-semibold mb-2",children:"Debug Info:"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:"User Info:"}),e.jsxs("p",{className:"text-sm",children:["User ID: ",n==null?void 0:n.id]}),e.jsxs("p",{className:"text-sm",children:["Email: ",n==null?void 0:n.email]}),e.jsxs("p",{className:"text-sm",children:["Auth Status: ",t.authStatus]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:"Supabase Config:"}),e.jsxs("p",{className:"text-sm",children:["URL: ",(E=t.supabaseUrl)==null?void 0:E.substring(0,30),"..."]}),e.jsxs("p",{className:"text-sm",children:["Anon Key: ",t.hasAnonKey?"‚úÖ Set":"‚ùå Missing"]})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"font-medium",children:"Profile Data:"}),e.jsx("pre",{className:"text-xs bg-white p-2 rounded overflow-auto",children:JSON.stringify(D,null,2)})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"font-medium",children:"Network Requests:"}),e.jsx("div",{className:"space-y-1 text-xs",children:t.networkRequests.map((c,x)=>e.jsxs("div",{className:`p-1 ${c.success?"bg-green-100":"bg-red-100"}`,children:[c.timestamp,": ",c.type," - ",c.success?"‚úÖ Success":`‚ùå Failed: ${c.error}`]},x))})]}),t.rlsError&&e.jsxs("div",{className:"mt-4 p-3 bg-red-100 border border-red-300 rounded",children:[e.jsx("p",{className:"text-red-700 font-medium",children:"‚ö†Ô∏è RLS Policy Issue Detected:"}),e.jsx("p",{className:"text-red-600 text-sm",children:t.rlsError})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"})]})};export{T as default,O as formatCurrency};
//# sourceMappingURL=Dashboard-DLXYiF5u.js.map
